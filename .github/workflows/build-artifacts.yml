name: Build Artifacts

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: windows-amd64
            runner: windows-latest
            setup_python: true
            checkout_clean: true
            python_cmd: python
            exe_name: integrated_script.exe
            out_name: integrated_script-${{ github.ref_name }}-windows-amd64.exe
          - name: linux-amd64
            runner: ubuntu-latest
            setup_python: false
            checkout_clean: true
            use_container: true
            container_image: ghcr.io/luohao091/integrated_script-build:py39
            container_python: /opt/venv/bin/python
            container_platform: linux/amd64
            docker_cmd: docker
            install_deps: false
            exe_name: integrated_script
            out_name: integrated_script-${{ github.ref_name }}-linux-amd64
          - name: linux-arm64
            runner:
              - self-hosted
              - Linux
              - ARM64
            setup_python: false
            checkout_clean: false
            use_container: true
            container_image: ghcr.io/luohao091/integrated_script-build:py39
            container_python: /opt/venv/bin/python
            container_platform: linux/arm64
            docker_cmd: sudo docker
            install_deps: false
            exe_name: integrated_script
            out_name: integrated_script-${{ github.ref_name }}-linux-arm64

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        clean: ${{ matrix.checkout_clean }}

    - uses: actions/setup-python@v5
      if: ${{ matrix.setup_python == true }}
      with:
        python-version: '3.11'

    - name: Pull build image (if updated)
      if: ${{ matrix.use_container == true }}
      shell: bash
      run: |
        ${{ matrix.docker_cmd }} pull --platform ${{ matrix.container_platform }} ${{ matrix.container_image }}

    - name: Build (container)
      if: ${{ matrix.use_container == true }}
      shell: bash
      run: |
        mkdir -p cache/pip cache/pyuser
        ${{ matrix.docker_cmd }} run --rm \
          --platform ${{ matrix.container_platform }} \
          -u "$(id -u):$(id -g)" \
          -v "$PWD:/work" \
          -v "$PWD/cache/pip:/work/.pip-cache" \
          -v "$PWD/cache/pyuser:/work/.pyuser" \
          -e HOME=/work \
          -e PIP_CACHE_DIR=/work/.pip-cache \
          -e PYTHONUSERBASE=/work/.pyuser \
          -e PYINSTALLER_CLEAN=0 \
          -w /work \
          ${{ matrix.container_image }} \
          bash -lc "
            set -euo pipefail
            PY_BIN=${{ matrix.container_python }}
            export PATH=\"/work/.pyuser/bin:\$PATH\"
            if [ \"${{ matrix.install_deps }}\" = \"true\" ]; then
              \$PY_BIN -m pip install -U pip
              \$PY_BIN -m pip install -r requirements.txt pyinstaller
            fi
            \$PY_BIN build_exe.py
          "

    - name: Build (hosted)
      if: ${{ matrix.use_container != true }}
      shell: bash
      run: |
        python -m pip install -U pip
        python -m pip install -r requirements.txt pyinstaller
        python build_exe.py

    - name: Rename executable with release tag
      env:
        EXE_NAME: ${{ matrix.exe_name }}
        OUT_NAME: ${{ matrix.out_name }}
      shell: bash
      run: |
        python - <<'PY'
        import os
        from pathlib import Path

        exe_name = os.environ.get("EXE_NAME")
        out_name = os.environ.get("OUT_NAME")
        exe = Path("dist") / exe_name
        if exe.exists() and out_name:
            exe.rename(exe.with_name(out_name))
        PY

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: dist/${{ matrix.out_name }}

name: Build and Release

# å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0 æ ¼å¼çš„æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        python build_exe.py
        
    - name: Verify build
      run: |
        if (Test-Path "dist/integrated_script.exe") {
          Write-Host "âœ… Build successful"
          $size = (Get-Item "dist/integrated_script.exe").Length / 1MB
          Write-Host "ğŸ“¦ File size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ Build failed - executable not found"
          exit 1
        }
        
    - name: Test executable
      run: |
        # æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œ
        ./dist/integrated_script.exe --version
        
    - name: Prepare release assets
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release"
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        Copy-Item "dist/integrated_script.exe" "release/"
        
        # å¤åˆ¶è¯´æ˜æ–‡ä»¶
        Copy-Item "README.md" "release/"
        Copy-Item "LICENSE" "release/"
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜
        @"
# é›†æˆè„šæœ¬å·¥å…· ä½¿ç”¨è¯´æ˜

## å¿«é€Ÿå¼€å§‹

1. ä¸‹è½½ integrated_script.exe
2. åŒå‡»è¿è¡Œæˆ–åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨
3. ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯

## ç³»ç»Ÿè¦æ±‚

- Windows 7/8/10/11 (64ä½)
- æ— éœ€å®‰è£… Python ç¯å¢ƒ

## ä½¿ç”¨ç¤ºä¾‹

```bash
# å¯åŠ¨äº¤äº’å¼ç•Œé¢
integrated_script.exe --interactive

# YOLOæ•°æ®é›†éªŒè¯
integrated_script.exe yolo validate /path/to/dataset

# å›¾åƒæ ¼å¼è½¬æ¢
integrated_script.exe image convert /path/to/images
```

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ README.md
"@ | Out-File -FilePath "release/ä½¿ç”¨è¯´æ˜.txt" -Encoding UTF8
        
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path "release/*" -DestinationPath "integrated_script_${{ github.ref_name }}_windows.zip"
        
    - name: Generate release notes
      id: release_notes
      run: |
        $tag = "${{ github.ref_name }}"
        $notes = @"
## ğŸ‰ é›†æˆè„šæœ¬å·¥å…· $tag

### ğŸ“¥ ä¸‹è½½

- **Windows å¯æ‰§è¡Œæ–‡ä»¶**: integrated_script_${tag}_windows.zip
- **å•ç‹¬å¯æ‰§è¡Œæ–‡ä»¶**: integrated_script.exe

### ğŸš€ æ–°åŠŸèƒ½

- YOLO æ•°æ®é›†å¤„ç†å’ŒéªŒè¯
- å›¾åƒæ‰¹é‡å¤„ç†å’Œæ ¼å¼è½¬æ¢
- æ™ºèƒ½æ–‡ä»¶ç»„ç»‡å’Œç®¡ç†
- æ ‡ç­¾æ–‡ä»¶åˆ›å»ºå’Œç¼–è¾‘
- äº¤äº’å¼å’Œå‘½ä»¤è¡ŒåŒæ¨¡å¼æ“ä½œ

### ğŸ’» ç³»ç»Ÿè¦æ±‚

- Windows 7/8/10/11 (64ä½ç³»ç»Ÿ)
- æ— éœ€å®‰è£… Python ç¯å¢ƒ

### ğŸ”§ ä½¿ç”¨æ–¹æ³•

1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
2. åŒå‡» `integrated_script.exe` å¯åŠ¨
3. æˆ–åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨: `integrated_script.exe --help`

### ğŸ“ æ›´æ–°æ—¥å¿—

- ä¼˜åŒ–äº†æ‰“åŒ…é…ç½®
- æ”¹è¿›äº†é”™è¯¯å¤„ç†
- å¢å¼ºäº†è·¨å¹³å°å…¼å®¹æ€§

---

**å®Œæ•´æºä»£ç **: [GitHub Repository](https://github.com/${{ github.repository }})
"@
        echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_OUTPUT
        echo $notes >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: "é›†æˆè„šæœ¬å·¥å…· ${{ github.ref_name }}"
        body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
        files: |
          integrated_script_${{ github.ref_name }}_windows.zip
          dist/integrated_script.exe
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: |
          dist/integrated_script.exe
          integrated_script_${{ github.ref_name }}_windows.zip
        retention-days: 30